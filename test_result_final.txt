============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
plugins: anyio-4.12.0, mock-3.15.1, Faker-39.0.0, asyncio-1.3.0, langsmith-0.5.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 6 items

tests/test_e2e/test_coaching_flow.py FF                                  [ 33%]
tests/test_e2e/test_coaching_silver_features.py ...F                     [100%]

=================================== FAILURES ===================================
__________ TestCoachingFlowE2E.test_full_coaching_to_site_generation ___________
tests/test_e2e/test_coaching_flow.py:29: in test_full_coaching_to_site_generation
    assert len(data["clickable_choices"]) > 0
E   assert 0 > 0
E    +  where 0 = len([])
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:09:03 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:09:04 [info     ] Request completed              duration_seconds=0.45998120307922363 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:09:04 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:09:04 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:04 [info     ] Request completed              duration_seconds=0.0633854866027832 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
_____________ TestCoachingFlowE2E.test_coaching_validation_failure _____________
tests/test_e2e/test_coaching_flow.py:91: in test_coaching_validation_failure
    assert "préciser" in data["coach_message"].lower() or "pouvez-vous" in data["coach_message"].lower()
E   assert ('préciser' in "je comprends que vous êtes d'accord pour partager votre vision. pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? où voyez-vous votre entreprise dans 5 ans ? quelle est l'ambition qui vous motive chaque jour ?" or 'pouvez-vous' in "je comprends que vous êtes d'accord pour partager votre vision. pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? où voyez-vous votre entreprise dans 5 ans ? quelle est l'ambition qui vous motive chaque jour ?")
E    +  where "je comprends que vous êtes d'accord pour partager votre vision. pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? où voyez-vous votre entreprise dans 5 ans ? quelle est l'ambition qui vous motive chaque jour ?" = <built-in method lower of str object at 0x7fde156762b0>()
E    +    where <built-in method lower of str object at 0x7fde156762b0> = "Je comprends que vous êtes d'accord pour partager votre vision. Pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? Où voyez-vous votre entreprise dans 5 ans ? Quelle est l'ambition qui vous motive chaque jour ?".lower
E    +  and   "je comprends que vous êtes d'accord pour partager votre vision. pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? où voyez-vous votre entreprise dans 5 ans ? quelle est l'ambition qui vous motive chaque jour ?" = <built-in method lower of str object at 0x7fde156762b0>()
E    +    where <built-in method lower of str object at 0x7fde156762b0> = "Je comprends que vous êtes d'accord pour partager votre vision. Pourriez-vous me décrire votre vision pour votre entr...ans votre communauté ? Où voyez-vous votre entreprise dans 5 ans ? Quelle est l'ambition qui vous motive chaque jour ?".lower
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:09:07 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:09:07 [info     ] Request completed              duration_seconds=0.44334912300109863 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:09:07 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:09:07 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:07 [info     ] Request completed              duration_seconds=0.05074357986450195 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 08:09:07 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/step
2025-12-20 08:09:07 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:09:07 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:09:07 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:07 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:09:07 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:07 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=622 temperature=0.1
2025-12-20 08:09:09 [info     ] Deepseek generate success      response_length=7 tokens_used=210
2025-12-20 08:09:09 [info     ] sector_detected                sector=default
2025-12-20 08:09:09 [info     ] requesting_llm_extraction      sector=default step=vision
2025-12-20 08:09:09 [info     ] Deepseek generate_structured request
2025-12-20 08:09:09 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=1314 temperature=0.3
2025-12-20 08:09:18 [info     ] Deepseek generate success      response_length=989 tokens_used=1129
2025-12-20 08:09:18 [info     ] Deepseek structured response parsed successfully
2025-12-20 08:09:18 [info     ] llm_extraction_completed       clarification=True confidence=0.1 is_valid=False step=vision
2025-12-20 08:09:18 [info     ] Request completed              duration_seconds=10.742777109146118 method=POST status_code=200 url=http://testserver/api/v1/coaching/step
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
____________ TestSilverCoachingFeaturesE2E.test_generate_proposals _____________
tests/test_e2e/test_coaching_silver_features.py:84: in test_generate_proposals
    assert any("transport" in p["text"].lower() for p in data["proposals"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_e2e/test_coaching_silver_features.py:84: in <genexpr>
    assert any("transport" in p["text"].lower() for p in data["proposals"])
                              ^^^^^^^^^
E   KeyError: 'text'
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:09:41 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:09:42 [info     ] Request completed              duration_seconds=0.44391798973083496 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:09:42 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:09:42 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:42 [info     ] Request completed              duration_seconds=0.03632712364196777 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 08:09:42 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/generate-proposals
2025-12-20 08:09:42 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:09:42 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:09:42 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:09:42 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:09:42 [info     ] Deepseek generate_structured request
2025-12-20 08:09:42 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=622 temperature=0.3
2025-12-20 08:10:04 [info     ] Deepseek generate success      response_length=2646 tokens_used=1029
2025-12-20 08:10:04 [info     ] Deepseek structured response parsed successfully
2025-12-20 08:10:04 [info     ] Request completed              duration_seconds=22.026046752929688 method=POST status_code=200 url=http://testserver/api/v1/coaching/generate-proposals
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/generate-proposals "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/generate-proposals "HTTP/1.1 200 OK"
=========================== short test summary info ============================
FAILED tests/test_e2e/test_coaching_flow.py::TestCoachingFlowE2E::test_full_coaching_to_site_generation
FAILED tests/test_e2e/test_coaching_flow.py::TestCoachingFlowE2E::test_coaching_validation_failure
FAILED tests/test_e2e/test_coaching_silver_features.py::TestSilverCoachingFeaturesE2E::test_generate_proposals
============= 3 failed, 3 passed, 21 warnings in 62.18s (0:01:02) ==============
