============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
plugins: anyio-4.12.0, mock-3.15.1, Faker-39.0.0, asyncio-1.3.0, langsmith-0.5.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 6 items

tests/test_e2e/test_coaching_flow.py FF                                  [ 33%]
tests/test_e2e/test_coaching_silver_features.py FF.F                     [100%]

=================================== FAILURES ===================================
__________ TestCoachingFlowE2E.test_full_coaching_to_site_generation ___________

self = <tests.test_e2e.test_coaching_flow.TestCoachingFlowE2E object at 0x7f1b038c1710>
client = <httpx.AsyncClient object at 0x7f1b03727190>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODEwOTIwfQ.TxVfjMfR8OZh0R0A0uQOBPYXWnWpSSmqFcCgpyuY604'}
test_user = <app.models.user.User object at 0x7f1b1f901610>

    async def test_full_coaching_to_site_generation(self, client: AsyncClient, auth_headers: dict, test_user: User):
        """ Tests a complete coaching journey for a fictional salon. """
    
        # 1. Start session
        start_response = await client.post(
            "/api/v1/coaching/start",
            json={"message": "Je veux ouvrir un salon de coiffure moderne à Dakar."},
            headers=auth_headers
        )
        assert start_response.status_code == 200
        data = start_response.json()
        session_id = data["session_id"]
        assert data["current_step"] == CoachingStepEnum.VISION.value
        assert len(data["clickable_choices"]) > 0
    
        # Steps to complete (Simulating user responses)
        steps = [
            (CoachingStepEnum.VISION, "Devenir le salon de référence pour la coiffure africaine moderne."),
            (CoachingStepEnum.MISSION, "Offrir des soins de haute qualité tout en préservant les traditions."),
            (CoachingStepEnum.CLIENTELE, "Les femmes actives de Dakar cherchant élégance et rapidité."),
            (CoachingStepEnum.DIFFERENTIATION, "Utilisation de produits 100% locaux et une app de réservation exclusive."),
            (CoachingStepEnum.OFFRE, "Tresses, soins capillaires bio et manucure de luxe.")
        ]
    
        for step_enum, response_text in steps:
            step_response = await client.post(
                "/api/v1/coaching/step",
                json={
                    "session_id": session_id,
                    "user_response": response_text
                },
                headers=auth_headers
            )
            assert step_response.status_code == 200
            step_data = step_response.json()
    
            # If it's not the last step, check transition
            if step_enum != CoachingStepEnum.OFFRE:
>               assert step_data["is_step_complete"] is True
E               assert False is True

tests/test_e2e/test_coaching_flow.py:54: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:21:59 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:22:00 [info     ] Request completed              duration_seconds=0.44765424728393555 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:22:00 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:00 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:00 [info     ] Session started                choices_count=3 session_id=69b7d3ed-9ac9-4ff6-98ad-d2099205867e
2025-12-20 08:22:00 [info     ] Request completed              duration_seconds=0.07298779487609863 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:00 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/step
2025-12-20 08:22:00 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:22:00 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:22:00 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:00 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:22:00 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:00 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=685 temperature=0.1
2025-12-20 08:22:01 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:01 [error    ] sector_detection_failed        error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:01 [info     ] requesting_llm_extraction      sector=default step=vision
2025-12-20 08:22:01 [info     ] Deepseek generate_structured request
2025-12-20 08:22:01 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=1377 temperature=0.3
2025-12-20 08:22:01 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:01 [error    ] llm_extraction_failed          error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)' step=vision
2025-12-20 08:22:02 [info     ] Request completed              duration_seconds=1.353496789932251 method=POST status_code=200 url=http://testserver/api/v1/coaching/step
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
_____________ TestCoachingFlowE2E.test_coaching_validation_failure _____________

self = <tests.test_e2e.test_coaching_flow.TestCoachingFlowE2E object at 0x7f1b03b01e10>
client = <httpx.AsyncClient object at 0x7f1b03572e90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODEwOTI0fQ.Wrf4t9chreQzL37Ba_ZwWGvzL5CwVJsER9rapslPalI'}

    async def test_coaching_validation_failure(self, client: AsyncClient, auth_headers: dict):
        """ Tests that insufficient responses block progression. """
    
        # Start session
        start_response = await client.post("/api/v1/coaching/start", json={}, headers=auth_headers)
        session_id = start_response.json()["session_id"]
    
        # Send a very short/vague response
        step_response = await client.post(
            "/api/v1/coaching/step",
            json={
                "session_id": session_id,
                "user_response": "Ok"
            },
            headers=auth_headers
        )
        assert step_response.status_code == 200
        data = step_response.json()
    
        # Should stay on VISION
        assert data["is_step_complete"] is False
>       assert data["current_step"] == CoachingStepEnum.VISION.value
E       AssertionError: assert 'mission' == 'vision'
E         
E         - vision
E         ? ^
E         + mission
E         ? ^ +

tests/test_e2e/test_coaching_flow.py:90: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:22:04 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:22:04 [info     ] Request completed              duration_seconds=0.4361395835876465 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:22:04 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:04 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:04 [info     ] Session started                choices_count=3 session_id=1d9230f3-e0ac-4bd8-86e4-966ce03ca675
2025-12-20 08:22:04 [info     ] Request completed              duration_seconds=0.04369831085205078 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:04 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/step
2025-12-20 08:22:04 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:22:04 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:22:04 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:04 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:22:04 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:04 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=622 temperature=0.1
2025-12-20 08:22:04 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:04 [error    ] sector_detection_failed        error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:04 [info     ] requesting_llm_extraction      sector=default step=vision
2025-12-20 08:22:04 [info     ] Deepseek generate_structured request
2025-12-20 08:22:04 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=1314 temperature=0.3
2025-12-20 08:22:04 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:04 [error    ] llm_extraction_failed          error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)' step=vision
2025-12-20 08:22:04 [info     ] Request completed              duration_seconds=0.1671459674835205 method=POST status_code=200 url=http://testserver/api/v1/coaching/step
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
__________ TestSilverCoachingFeaturesE2E.test_coaching_help_socratic ___________

self = <tests.test_e2e.test_coaching_silver_features.TestSilverCoachingFeaturesE2E object at 0x7f1b03867950>
client = <httpx.AsyncClient object at 0x7f1b03503150>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODEwOTI2fQ.SxCMy-4lnTBbN6AGXTLn5YJ7Xuhq_thHd7x4yNhwJ0k'}

    async def test_coaching_help_socratic(self, client: AsyncClient, auth_headers: dict):
        """Tests the assistance button (Socratic questions)."""
    
        # Start
        start_res = await client.post("/api/v1/coaching/start", json={}, headers=auth_headers)
        session_id = start_res.json()["session_id"]
    
        # Request help
        help_res = await client.post(
            "/api/v1/coaching/help",
            json={"session_id": session_id},
            headers=auth_headers
        )
        assert help_res.status_code == 200
        data = help_res.json()
        assert "socratic_questions" in data
>       assert len(data["socratic_questions"]) >= 2
E       assert 0 >= 2
E        +  where 0 = len([])

tests/test_e2e/test_coaching_silver_features.py:29: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:22:05 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:22:06 [info     ] Request completed              duration_seconds=0.5116450786590576 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:22:06 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:06 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:06 [info     ] Session started                choices_count=3 session_id=c101e861-7146-4537-9ad0-bf3b01ab8218
2025-12-20 08:22:06 [info     ] Request completed              duration_seconds=0.040343523025512695 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:06 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/help
2025-12-20 08:22:06 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:22:06 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:22:06 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:06 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:22:06 [info     ] Deepseek generate_structured request
2025-12-20 08:22:06 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=601 temperature=0.3
2025-12-20 08:22:06 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:06 [error    ] socratic_help_failed           error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:06 [info     ] Request completed              duration_seconds=0.11557388305664062 method=POST status_code=200 url=http://testserver/api/v1/coaching/help
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/help "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/help "HTTP/1.1 200 OK"
__________ TestSilverCoachingFeaturesE2E.test_reformulate_on_the_fly ___________

self = <tests.test_e2e.test_coaching_silver_features.TestSilverCoachingFeaturesE2E object at 0x7f1b03867450>
client = <httpx.AsyncClient object at 0x7f1b03672990>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODEwOTI3fQ.AyfzFrwETvbKZtelx4hAhxldZxu30vpZqTOsdkRnqlM'}

    async def test_reformulate_on_the_fly(self, client: AsyncClient, auth_headers: dict):
        """Tests real-time text reformulation."""
    
        long_text = "Je veux faire un truc de livraison de nourriture bio mais je sais pas trop comment dire ça proprement pour que ça fasse pro."
    
        response = await client.post(
            "/api/v1/coaching/reformulate",
            json={
                "session_id": "test-session-reformulate",
                "text": long_text,
                "target_step": "vision"
            },
            headers=auth_headers
        )
        assert response.status_code == 200
        data = response.json()
>       assert data["reformulated_text"] != long_text
E       AssertionError: assert 'Je veux faire un truc de livraison de nourriture bio mais je sais pas trop comment dire ça proprement pour que ça fasse pro.' != 'Je veux faire un truc de livraison de nourriture bio mais je sais pas trop comment dire ça proprement pour que ça fasse pro.'

tests/test_e2e/test_coaching_silver_features.py:48: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:22:07 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:22:07 [info     ] Request completed              duration_seconds=0.4205324649810791 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:22:07 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/reformulate
2025-12-20 08:22:07 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 08:22:07 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 08:22:07 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 08:22:07 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 08:22:07 [info     ] Deepseek generate_structured request
2025-12-20 08:22:07 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=666 temperature=0.3
2025-12-20 08:22:07 [error    ] Deepseek network error         error='[SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:07 [error    ] reformulation_failed           error='Deepseek network error: [SSL: SSLV3_ALERT_HANDSHAKE_FAILURE] ssl/tls alert handshake failure (_ssl.c:1016)'
2025-12-20 08:22:07 [info     ] Request completed              duration_seconds=0.09993577003479004 method=POST status_code=200 url=http://testserver/api/v1/coaching/reformulate
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/reformulate "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/reformulate "HTTP/1.1 200 OK"
____________ TestSilverCoachingFeaturesE2E.test_generate_proposals _____________

self = <tests.test_e2e.test_coaching_silver_features.TestSilverCoachingFeaturesE2E object at 0x7f1b03863e10>
client = <httpx.AsyncClient object at 0x7f1b033d3090>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODEwOTMwfQ.Jf5yhFgD9G0tkOX_I-8p6O79IGgpctTNtKDSO1LPWnk'}

    async def test_generate_proposals(self, client: AsyncClient, auth_headers: dict):
        """Tests the 'I don't know' mode generating 3 proposals."""
    
        # Start with a specific sector to ensure we have examples/proposals
        start_res = await client.post("/api/v1/coaching/start", headers=auth_headers)
>       session_id = start_res.json()["session_id"]
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'session_id'

tests/test_e2e/test_coaching_silver_features.py:73: KeyError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 08:22:10 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 08:22:10 [info     ] Request completed              duration_seconds=0.43593716621398926 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 08:22:10 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 08:22:10 [info     ] Request completed              duration_seconds=0.013778924942016602 method=POST status_code=422 url=http://testserver/api/v1/coaching/start
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 422 Unprocessable Entity"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 422 Unprocessable Entity"
=========================== short test summary info ============================
FAILED tests/test_e2e/test_coaching_flow.py::TestCoachingFlowE2E::test_full_coaching_to_site_generation
FAILED tests/test_e2e/test_coaching_flow.py::TestCoachingFlowE2E::test_coaching_validation_failure
FAILED tests/test_e2e/test_coaching_silver_features.py::TestSilverCoachingFeaturesE2E::test_coaching_help_socratic
FAILED tests/test_e2e/test_coaching_silver_features.py::TestSilverCoachingFeaturesE2E::test_reformulate_on_the_fly
FAILED tests/test_e2e/test_coaching_silver_features.py::TestSilverCoachingFeaturesE2E::test_generate_proposals
================== 5 failed, 1 passed, 21 warnings in 13.32s ===================
