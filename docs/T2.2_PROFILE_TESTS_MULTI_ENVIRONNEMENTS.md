# 🔧 Profile Tests Multi-environnements - T2.2

**Date :** 22 août 2025  
**Version :** 1.0  
**Suite à :** Work Order T2.2 - Support tests local + Docker avec même config

---

## 🎯 **Objectif Accompli**

Implémentation d'un système de **profils de tests multi-environnements** permettant d'exécuter les mêmes tests identiquement dans les environnements **LOCAL** et **DOCKER** avec détection automatique ou sélection manuelle.

---

## 🏗️ **Architecture du Système de Profils**

### **📁 Structure Files**
```
tests/
├── conftest.py                 # Point d'entrée principal (remplacé)
├── conftest_profile.py         # Gestionnaire de profils automatique
├── conftest_local.py           # Configuration LOCAL (PostgreSQL localhost:5433)
├── conftest_docker.py          # Configuration DOCKER (PostgreSQL test-db:5432)
└── test_profiles.sh            # Script de validation
```

### **🔄 Mécanisme de Sélection**

#### **1. Sélection Manuelle**
```bash
# Forcer profil LOCAL
export TEST_PROFILE=local
pytest tests/

# Forcer profil DOCKER  
export TEST_PROFILE=docker
pytest tests/
```

#### **2. Détection Automatique**
Le système détecte automatiquement l'environnement via :
1. **Variable explicite** : `TEST_PROFILE=local|docker`
2. **Variables Docker** : `RUNNING_IN_DOCKER`, `CONTAINER_NAME`
3. **Hostname** : patterns `genesis-*`, `*-api`
4. **Connectivité réseau** : test port 5433 (test-db local)
5. **Défaut** : LOCAL

---

## 📋 **Configurations par Profil**

### **💻 Profil LOCAL**
```python
# conftest_local.py
TEST_DATABASE_URL = "postgresql+asyncpg://test_user:test_password@localhost:5433/test_db"

Environment Variables:
- TESTING_MODE=true
- ENVIRONMENT=testing_local
- REDIS_URL=redis://localhost:6382/0
- STRICT_HEALTH_CHECKS=false
```

**Usage :**
- Tests depuis machine hôte
- PostgreSQL via Docker port exposé 5433
- Redis via Docker port exposé 6382

### **📦 Profil DOCKER**
```python
# conftest_docker.py
TEST_DATABASE_URL = "postgresql+asyncpg://test_user:test_password@test-db:5432/test_db"

Environment Variables:
- TESTING_MODE=true
- ENVIRONMENT=testing_docker
- REDIS_URL=redis://redis:6379/0
- STRICT_HEALTH_CHECKS=false
```

**Usage :**
- Tests depuis conteneur genesis-api
- PostgreSQL via réseau Docker interne
- Redis via réseau Docker interne

---

## 🧪 **Fixtures par Profil**

### **Fixtures Communes**
Toutes les fixtures sont automatiquement renommées vers des noms standards :
- `test_engine` → Engine PostgreSQL approprié
- `db_session` → Session base de données
- `client` → Client HTTP de test
- `test_user` → Utilisateur de test
- `auth_headers` → Headers d'authentification

### **Fixtures Spécialisées**

#### **LOCAL**
- `test_engine_local` → PostgreSQL localhost:5433
- `db_session_local` → Session locale
- `client_local` → Client local
- `test_user_local` → User "Test User Local"

#### **DOCKER**
- `test_engine_docker` → PostgreSQL test-db:5432
- `db_session_docker` → Session Docker
- `client_docker` → Client Docker
- `test_user_docker` → User "Test User Docker"

---

## 🔍 **Détection d'Environnement**

### **Méthodes de Détection**
```python
def detect_test_environment():
    # 1. Variable explicite
    test_profile = os.getenv("TEST_PROFILE", "").lower()
    if test_profile in ["local", "docker"]:
        return test_profile
    
    # 2. Variables Docker
    if os.getenv("RUNNING_IN_DOCKER") or os.getenv("CONTAINER_NAME"):
        return "docker"
    
    # 3. Hostname patterns
    hostname = os.getenv("HOSTNAME", "")
    if hostname.startswith("genesis-") or "-api" in hostname:
        return "docker"
    
    # 4. Test connectivité réseau
    # ... test port 5433
    
    # 5. Défaut
    return "local"
```

### **Informations Profil**
```python
TEST_PROFILE_INFO = {
    "environment": "local|docker",
    "database_url": "postgresql+asyncpg://...",
    "description": "Tests en environnement Local|Docker",
    "postgres_host": "localhost:5433|test-db:5432"
}
```

---

## ✅ **Validation & Tests**

### **Test Profil LOCAL**
```bash
🧪 Test Profile détecté: LOCAL
💻 Utilisation conftest_local.py pour environnement local
🔗 Base de données: postgresql+asyncpg://test_user:test_password@localhost:5433/test_db
📍 PostgreSQL: localhost:5433
```

### **Test Profil DOCKER**
```bash
🧪 Test Profile détecté: DOCKER
📦 Utilisation conftest_docker.py pour environnement conteneurisé
🔗 Base de données: postgresql+asyncpg://test_user:test_password@test-db:5432/test_db
📍 PostgreSQL: test-db:5432
```

### **Commandes de Test**
```bash
# Test local explicite
export TEST_PROFILE=local
pytest tests/test_api/test_auth.py -v

# Test Docker explicite
export TEST_PROFILE=docker
pytest tests/test_api/test_auth.py -v

# Test avec détection automatique
pytest tests/test_api/test_auth.py -v
```

---

## 🚀 **Utilisation Pratique**

### **Développement Local**
```bash
# Démarrer services
docker-compose up -d test-db redis

# Tests avec profil local (défaut)
pytest tests/

# Tests avec profil local explicite
TEST_PROFILE=local pytest tests/
```

### **Environnement Docker**
```bash
# Depuis conteneur
docker-compose exec genesis-api pytest tests/

# Avec profil Docker explicite
docker-compose exec genesis-api bash -c "TEST_PROFILE=docker pytest tests/"
```

### **CI/CD Integration**
```yaml
# GitHub Actions / GitLab CI
- name: Test Local
  run: |
    TEST_PROFILE=local pytest tests/
    
- name: Test Docker
  run: |
    docker-compose exec genesis-api bash -c "TEST_PROFILE=docker pytest tests/"
```

---

## 📊 **Avantages du Système**

### **✅ Parité Environnementale**
- Même PostgreSQL dans les deux profils
- Configurations identiques adaptées au contexte
- Tests reproductibles et fiables

### **✅ Flexibilité**
- Sélection manuelle ou détection automatique
- Adaptation transparente au contexte d'exécution
- Support des pipelines CI/CD

### **✅ Simplicité**
- Import unique : `from tests.conftest_profile import *`
- Fixtures standards identiques
- Migration transparente depuis l'ancien conftest.py

### **✅ Debugging**
- Informations de profil explicites
- Logs de détection d'environnement
- Métadonnées de configuration accessible

---

## 🔧 **Migration depuis Ancien Système**

### **Avant (conftest.py monolithique)**
```python
# Configuration fixe SQLite/PostgreSQL
TEST_DATABASE_URL = os.getenv("TEST_DATABASE_URL", "sqlite+aiosqlite:///test.db")
```

### **Après (système de profils)**
```python
# Sélection automatique selon environnement
from tests.conftest_profile import *
# Tout est automatique !
```

### **Compatibilité**
- ✅ Tous les tests existants fonctionnent sans modification
- ✅ Mêmes noms de fixtures
- ✅ Même comportement attendu
- ✅ Performance équivalente

---

## 🎯 **Critères de Succès T2.2**

### **✅ Support Local + Docker**
- [x] Configuration profil LOCAL (PostgreSQL localhost:5433)
- [x] Configuration profil DOCKER (PostgreSQL test-db:5432)
- [x] Sélection automatique d'environnement
- [x] Sélection manuelle via TEST_PROFILE

### **✅ Même Configuration**
- [x] PostgreSQL dans les deux profils (parité T4.1)
- [x] Fixtures identiques et interchangeables
- [x] Variables d'environnement cohérentes
- [x] Behavior identique des tests

### **✅ Tests Identiques**
- [x] Tests passent en LOCAL
- [x] Tests passent en DOCKER
- [x] Résultats identiques
- [x] Performance similaire

---

## 📝 **Fichiers Créés**

1. **`tests/conftest_profile.py`** - Gestionnaire de profils automatique
2. **`tests/conftest_local.py`** - Configuration environnement LOCAL
3. **`tests/conftest_docker.py`** - Configuration environnement DOCKER
4. **`tests/conftest.py`** - Point d'entrée unifié (modifié)
5. **`test_profiles.sh`** - Script de validation

---

## 🏁 **Statut Final**

✅ **T2.2 TERMINÉ** - Profile Tests Multi-environnements  
🎯 **Objectif atteint** : Support tests local + Docker avec même config  
⚡ **Prêt pour** : T4.2 Docker Test Profile Complet

---

**Documentation créée le 22 août 2025**  
**Validation** : Tests LOCAL ✅ + DOCKER ✅ + Détection automatique ✅