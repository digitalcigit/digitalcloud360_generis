# ğŸ”§ Profile Tests Multi-environnements - T2.2

**Date :** 22 aoÃ»t 2025  
**Version :** 1.0  
**Suite Ã  :** Work Order T2.2 - Support tests local + Docker avec mÃªme config

---

## ğŸ¯ **Objectif Accompli**

ImplÃ©mentation d'un systÃ¨me de **profils de tests multi-environnements** permettant d'exÃ©cuter les mÃªmes tests identiquement dans les environnements **LOCAL** et **DOCKER** avec dÃ©tection automatique ou sÃ©lection manuelle.

---

## ğŸ—ï¸ **Architecture du SystÃ¨me de Profils**

### **ğŸ“ Structure Files**
```
tests/
â”œâ”€â”€ conftest.py                 # Point d'entrÃ©e principal (remplacÃ©)
â”œâ”€â”€ conftest_profile.py         # Gestionnaire de profils automatique
â”œâ”€â”€ conftest_local.py           # Configuration LOCAL (PostgreSQL localhost:5433)
â”œâ”€â”€ conftest_docker.py          # Configuration DOCKER (PostgreSQL test-db:5432)
â””â”€â”€ test_profiles.sh            # Script de validation
```

### **ğŸ”„ MÃ©canisme de SÃ©lection**

#### **1. SÃ©lection Manuelle**
```bash
# Forcer profil LOCAL
export TEST_PROFILE=local
pytest tests/

# Forcer profil DOCKER  
export TEST_PROFILE=docker
pytest tests/
```

#### **2. DÃ©tection Automatique**
Le systÃ¨me dÃ©tecte automatiquement l'environnement via :
1. **Variable explicite** : `TEST_PROFILE=local|docker`
2. **Variables Docker** : `RUNNING_IN_DOCKER`, `CONTAINER_NAME`
3. **Hostname** : patterns `genesis-*`, `*-api`
4. **ConnectivitÃ© rÃ©seau** : test port 5433 (test-db local)
5. **DÃ©faut** : LOCAL

---

## ğŸ“‹ **Configurations par Profil**

### **ğŸ’» Profil LOCAL**
```python
# conftest_local.py
TEST_DATABASE_URL = "postgresql+asyncpg://test_user:test_password@localhost:5433/test_db"

Environment Variables:
- TESTING_MODE=true
- ENVIRONMENT=testing_local
- REDIS_URL=redis://localhost:6382/0
- STRICT_HEALTH_CHECKS=false
```

**Usage :**
- Tests depuis machine hÃ´te
- PostgreSQL via Docker port exposÃ© 5433
- Redis via Docker port exposÃ© 6382

### **ğŸ“¦ Profil DOCKER**
```python
# conftest_docker.py
TEST_DATABASE_URL = "postgresql+asyncpg://test_user:test_password@test-db:5432/test_db"

Environment Variables:
- TESTING_MODE=true
- ENVIRONMENT=testing_docker
- REDIS_URL=redis://redis:6379/0
- STRICT_HEALTH_CHECKS=false
```

**Usage :**
- Tests depuis conteneur genesis-api
- PostgreSQL via rÃ©seau Docker interne
- Redis via rÃ©seau Docker interne

---

## ğŸ§ª **Fixtures par Profil**

### **Fixtures Communes**
Toutes les fixtures sont automatiquement renommÃ©es vers des noms standards :
- `test_engine` â†’ Engine PostgreSQL appropriÃ©
- `db_session` â†’ Session base de donnÃ©es
- `client` â†’ Client HTTP de test
- `test_user` â†’ Utilisateur de test
- `auth_headers` â†’ Headers d'authentification

### **Fixtures SpÃ©cialisÃ©es**

#### **LOCAL**
- `test_engine_local` â†’ PostgreSQL localhost:5433
- `db_session_local` â†’ Session locale
- `client_local` â†’ Client local
- `test_user_local` â†’ User "Test User Local"

#### **DOCKER**
- `test_engine_docker` â†’ PostgreSQL test-db:5432
- `db_session_docker` â†’ Session Docker
- `client_docker` â†’ Client Docker
- `test_user_docker` â†’ User "Test User Docker"

---

## ğŸ” **DÃ©tection d'Environnement**

### **MÃ©thodes de DÃ©tection**
```python
def detect_test_environment():
    # 1. Variable explicite
    test_profile = os.getenv("TEST_PROFILE", "").lower()
    if test_profile in ["local", "docker"]:
        return test_profile
    
    # 2. Variables Docker
    if os.getenv("RUNNING_IN_DOCKER") or os.getenv("CONTAINER_NAME"):
        return "docker"
    
    # 3. Hostname patterns
    hostname = os.getenv("HOSTNAME", "")
    if hostname.startswith("genesis-") or "-api" in hostname:
        return "docker"
    
    # 4. Test connectivitÃ© rÃ©seau
    # ... test port 5433
    
    # 5. DÃ©faut
    return "local"
```

### **Informations Profil**
```python
TEST_PROFILE_INFO = {
    "environment": "local|docker",
    "database_url": "postgresql+asyncpg://...",
    "description": "Tests en environnement Local|Docker",
    "postgres_host": "localhost:5433|test-db:5432"
}
```

---

## âœ… **Validation & Tests**

### **Test Profil LOCAL**
```bash
ğŸ§ª Test Profile dÃ©tectÃ©: LOCAL
ğŸ’» Utilisation conftest_local.py pour environnement local
ğŸ”— Base de donnÃ©es: postgresql+asyncpg://test_user:test_password@localhost:5433/test_db
ğŸ“ PostgreSQL: localhost:5433
```

### **Test Profil DOCKER**
```bash
ğŸ§ª Test Profile dÃ©tectÃ©: DOCKER
ğŸ“¦ Utilisation conftest_docker.py pour environnement conteneurisÃ©
ğŸ”— Base de donnÃ©es: postgresql+asyncpg://test_user:test_password@test-db:5432/test_db
ğŸ“ PostgreSQL: test-db:5432
```

### **Commandes de Test**
```bash
# Test local explicite
export TEST_PROFILE=local
pytest tests/test_api/test_auth.py -v

# Test Docker explicite
export TEST_PROFILE=docker
pytest tests/test_api/test_auth.py -v

# Test avec dÃ©tection automatique
pytest tests/test_api/test_auth.py -v
```

---

## ğŸš€ **Utilisation Pratique**

### **DÃ©veloppement Local**
```bash
# DÃ©marrer services
docker-compose up -d test-db redis

# Tests avec profil local (dÃ©faut)
pytest tests/

# Tests avec profil local explicite
TEST_PROFILE=local pytest tests/
```

### **Environnement Docker**
```bash
# Depuis conteneur
docker-compose exec genesis-api pytest tests/

# Avec profil Docker explicite
docker-compose exec genesis-api bash -c "TEST_PROFILE=docker pytest tests/"
```

### **CI/CD Integration**
```yaml
# GitHub Actions / GitLab CI
- name: Test Local
  run: |
    TEST_PROFILE=local pytest tests/
    
- name: Test Docker
  run: |
    docker-compose exec genesis-api bash -c "TEST_PROFILE=docker pytest tests/"
```

---

## ğŸ“Š **Avantages du SystÃ¨me**

### **âœ… ParitÃ© Environnementale**
- MÃªme PostgreSQL dans les deux profils
- Configurations identiques adaptÃ©es au contexte
- Tests reproductibles et fiables

### **âœ… FlexibilitÃ©**
- SÃ©lection manuelle ou dÃ©tection automatique
- Adaptation transparente au contexte d'exÃ©cution
- Support des pipelines CI/CD

### **âœ… SimplicitÃ©**
- Import unique : `from tests.conftest_profile import *`
- Fixtures standards identiques
- Migration transparente depuis l'ancien conftest.py

### **âœ… Debugging**
- Informations de profil explicites
- Logs de dÃ©tection d'environnement
- MÃ©tadonnÃ©es de configuration accessible

---

## ğŸ”§ **Migration depuis Ancien SystÃ¨me**

### **Avant (conftest.py monolithique)**
```python
# Configuration fixe SQLite/PostgreSQL
TEST_DATABASE_URL = os.getenv("TEST_DATABASE_URL", "sqlite+aiosqlite:///test.db")
```

### **AprÃ¨s (systÃ¨me de profils)**
```python
# SÃ©lection automatique selon environnement
from tests.conftest_profile import *
# Tout est automatique !
```

### **CompatibilitÃ©**
- âœ… Tous les tests existants fonctionnent sans modification
- âœ… MÃªmes noms de fixtures
- âœ… MÃªme comportement attendu
- âœ… Performance Ã©quivalente

---

## ğŸ¯ **CritÃ¨res de SuccÃ¨s T2.2**

### **âœ… Support Local + Docker**
- [x] Configuration profil LOCAL (PostgreSQL localhost:5433)
- [x] Configuration profil DOCKER (PostgreSQL test-db:5432)
- [x] SÃ©lection automatique d'environnement
- [x] SÃ©lection manuelle via TEST_PROFILE

### **âœ… MÃªme Configuration**
- [x] PostgreSQL dans les deux profils (paritÃ© T4.1)
- [x] Fixtures identiques et interchangeables
- [x] Variables d'environnement cohÃ©rentes
- [x] Behavior identique des tests

### **âœ… Tests Identiques**
- [x] Tests passent en LOCAL
- [x] Tests passent en DOCKER
- [x] RÃ©sultats identiques
- [x] Performance similaire

---

## ğŸ“ **Fichiers CrÃ©Ã©s**

1. **`tests/conftest_profile.py`** - Gestionnaire de profils automatique
2. **`tests/conftest_local.py`** - Configuration environnement LOCAL
3. **`tests/conftest_docker.py`** - Configuration environnement DOCKER
4. **`tests/conftest.py`** - Point d'entrÃ©e unifiÃ© (modifiÃ©)
5. **`test_profiles.sh`** - Script de validation

---

## ğŸ **Statut Final**

âœ… **T2.2 TERMINÃ‰** - Profile Tests Multi-environnements  
ğŸ¯ **Objectif atteint** : Support tests local + Docker avec mÃªme config  
âš¡ **PrÃªt pour** : T4.2 Docker Test Profile Complet

---

**Documentation crÃ©Ã©e le 22 aoÃ»t 2025**  
**Validation** : Tests LOCAL âœ… + DOCKER âœ… + DÃ©tection automatique âœ…