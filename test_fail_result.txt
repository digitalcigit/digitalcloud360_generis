============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
plugins: anyio-4.12.0, mock-3.15.1, Faker-39.0.0, asyncio-1.3.0, langsmith-0.5.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 4 items

tests/test_e2e/test_coaching_silver_features.py ...F                     [100%]

=================================== FAILURES ===================================
____________ TestSilverCoachingFeaturesE2E.test_generate_proposals _____________

self = <tests.test_e2e.test_coaching_silver_features.TestSilverCoachingFeaturesE2E object at 0x7f61f34dd710>
client = <httpx.AsyncClient object at 0x7f61f329c750>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY4ODE0MjA5fQ.V31cQHTnBBQvJu9pimrD0f7d_DzmnMQyOJoX0SWYtYI'}

    async def test_generate_proposals(self, client: AsyncClient, auth_headers: dict):
        """Tests the 'I don't know' mode generating 3 proposals."""
    
        # Start with a specific sector to ensure we have examples/proposals
        start_res = await client.post("/api/v1/coaching/start", json={}, headers=auth_headers)
        session_id = start_res.json()["session_id"]
    
        # Step with restaurant context to force sector detection
        await client.post(
            "/api/v1/coaching/step",
            json={"session_id": session_id, "user_response": "Je veux ouvrir un restaurant de spécialités ivoiriennes."},
            headers=auth_headers
        )
    
        # Get proposals
        prop_res = await client.post(
            "/api/v1/coaching/generate-proposals",
            json={"session_id": session_id},
            headers=auth_headers
        )
        assert prop_res.status_code == 200
        data = prop_res.json()
        assert len(data["proposals"]) == 3
        # Check for sector-relevant keywords
>       assert any(word in p["content"].lower() for p in data["proposals"] for word in ["restaurant", "cuisine", "plat", "alimentaire", "food"])
E       assert False
E        +  where False = any(<generator object TestSilverCoachingFeaturesE2E.test_generate_proposals.<locals>.<genexpr> at 0x7f61f31a13f0>)

tests/test_e2e/test_coaching_silver_features.py:92: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-12-20 09:16:49 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/auth/token
2025-12-20 09:16:49 [info     ] Request completed              duration_seconds=0.4311347007751465 method=POST status_code=200 url=http://testserver/api/v1/auth/token
---------------------------- Captured stderr setup -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/auth/token "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2025-12-20 09:16:49 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/start
2025-12-20 09:16:49 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 09:16:49 [info     ] Request completed              duration_seconds=0.04084372520446777 method=POST status_code=200 url=http://testserver/api/v1/coaching/start
2025-12-20 09:16:49 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/step
2025-12-20 09:16:49 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 09:16:49 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 09:16:49 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 09:16:49 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 09:16:49 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 09:16:49 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=676 temperature=0.1
2025-12-20 09:16:51 [info     ] Deepseek generate success      response_length=10 tokens_used=224
2025-12-20 09:16:51 [info     ] sector_detected                sector=restaurant
2025-12-20 09:16:51 [info     ] requesting_llm_extraction      sector=restaurant step=vision
2025-12-20 09:16:51 [info     ] Deepseek generate_structured request
2025-12-20 09:16:51 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=1371 temperature=0.3
2025-12-20 09:16:59 [info     ] Deepseek generate success      response_length=779 tokens_used=1090
2025-12-20 09:16:59 [info     ] Deepseek structured response parsed successfully
2025-12-20 09:16:59 [info     ] llm_extraction_completed       clarification=True confidence=0.3 is_valid=False step=vision
2025-12-20 09:16:59 [info     ] Request completed              duration_seconds=10.179555416107178 method=POST status_code=200 url=http://testserver/api/v1/coaching/step
2025-12-20 09:16:59 [info     ] Request started                client_ip=127.0.0.1 method=POST url=http://testserver/api/v1/coaching/generate-proposals
2025-12-20 09:16:59 [info     ] Création LLM provider          model=deepseek-chat plan=genesis_basic provider=deepseek
2025-12-20 09:16:59 [info     ] DeepseekProvider initialized   base_url=https://api.deepseek.com model=deepseek-chat
2025-12-20 09:16:59 [info     ] PromptsLoader initialized with 5 coaching steps
2025-12-20 09:16:59 [info     ] CoachingLLMService initialized with Deepseek provider
2025-12-20 09:16:59 [info     ] Deepseek generate_structured request
2025-12-20 09:16:59 [info     ] Deepseek generate request      model=deepseek-chat prompt_length=622 temperature=0.3
2025-12-20 09:17:24 [info     ] Deepseek generate success      response_length=2952 tokens_used=1105
2025-12-20 09:17:24 [info     ] Deepseek structured response parsed successfully
2025-12-20 09:17:24 [info     ] Request completed              duration_seconds=24.758007526397705 method=POST status_code=200 url=http://testserver/api/v1/coaching/generate-proposals
----------------------------- Captured stderr call -----------------------------
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://testserver/api/v1/coaching/generate-proposals "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/start "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/step "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://testserver/api/v1/coaching/generate-proposals "HTTP/1.1 200 OK"
=========================== short test summary info ============================
FAILED tests/test_e2e/test_coaching_silver_features.py::TestSilverCoachingFeaturesE2E::test_generate_proposals
================== 1 failed, 3 passed, 21 warnings in 58.85s ===================
